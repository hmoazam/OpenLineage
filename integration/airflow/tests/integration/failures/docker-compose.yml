version: "3.7"

services:
  integration:
    command: ["./wait-for-it.sh", "backend:5000", "--", "python", "test_failure.py"]

  airflow:
    environment:
      AIRFLOW__API__AUTH_BACKEND: airflow.api.auth.backend.basic_auth
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      OPENLINEAGE_URL: ${OPENLINEAGE_URL}
    volumes:
      - airflow_failed_dags:/opt/airflow/dags

  airflow_scheduler:
    environment:
      AIRFLOW__API__AUTH_BACKEND: airflow.api.auth.backend.basic_auth
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      OPENLINEAGE_URL: ${OPENLINEAGE_URL}
      OPENLINEAGE_EXTRACTOR_CustomOperator: ""
    volumes:
      - airflow_failed_dags:/opt/airflow/dags

  airflow_worker:
    environment:
      AIRFLOW__API__AUTH_BACKEND: airflow.api.auth.backend.basic_auth
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      OPENLINEAGE_URL: ${OPENLINEAGE_URL}
      OPENLINEAGE_EXTRACTOR_CustomOperator: ""
    volumes:
      - airflow_failed_dags:/opt/airflow/dags

  airflow_init:
    environment:
      AIRFLOW__API__AUTH_BACKEND: airflow.api.auth.backend.basic_auth
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      OPENLINEAGE_URL: ${OPENLINEAGE_URL}
      OPENLINEAGE_EXTRACTOR_CustomOperator: ""
    volumes:
      - airflow_failed_dags:/opt/airflow/dags
    entrypoint: ["/usr/bin/dumb-init", "--", "/entrypoint.sh", "/bin/bash"]
    command: -c "airflow db init && airflow users create --username airflow --password airflow --firstname airflow --lastname airflow --email airflow@example.com --role Admin"

